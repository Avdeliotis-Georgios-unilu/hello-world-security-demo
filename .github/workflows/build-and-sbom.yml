name: Build and Generate SBOM

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

jobs:
  build:
    name: Build Java Application
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Java 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: maven

      - name: Build with Maven
        run: mvn clean package

      - name: Upload SBOMs as artifacts
        uses: actions/upload-artifact@v4
        with:
          name: sboms
          path: |
            target/hello-world-bom.json
            target/hello-world-bom.xml
          retention-days: 30  # Keep artifacts for 30 days

      - name: Display generated SBOM
        run: |
          echo "=== CycloneDX SBOM (JSON) ==="
          cat target/hello-world-bom.json | head -20
          echo ""
          echo "=== SBOM Component Count ==="
          grep -c '"name"' target/hello-world-bom.json || echo "0"

  security-scan:
    name: Security Scanning
    runs-on: ubuntu-latest
    needs: build
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Java 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: maven

      - name: Run Maven package
        run: mvn clean package


      # Grype install
      - name: Install Grype
        run: |
         curl -sSfL https://raw.githubusercontent.com/anchore/grype/main/install.sh | sh -s -- -b /usr/local/bin

      - name: Scan SBOM for vulnerabilities
        run: |
          grype sbom:target/hello-world-bom.json --fail-on high
          grype sbom:target/hello-world-bom.json -o table